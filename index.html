<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distance Means Nothing ❤️</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>

    <style>
        :root {
            --primary: #ff2e63;
            --bg: #0a0a0a;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.12);
            --text: #ffffff;
            --accent: #ff8ca6;
            --empty: #1a1a1a;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg);
            background-image: 
                radial-gradient(circle at 10% 10%, rgba(255, 46, 99, 0.08) 0%, transparent 30%),
                radial-gradient(circle at 90% 90%, rgba(255, 46, 99, 0.08) 0%, transparent 30%);
            color: var(--text);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            overflow-x: hidden;
        }

        #app {
            width: 100%;
            max-width: 450px;
            padding: 40px 20px;
            text-align: center;
        }

        .glass {
            background: var(--glass);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
        }

        .overlay-screen {
            position: fixed;
            inset: 0;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 30px;
        }

        .heart-icon {
            font-size: 4rem;
            color: var(--primary);
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); filter: drop-shadow(0 0 10px var(--primary)); }
            50% { transform: scale(1.1); filter: drop-shadow(0 0 25px var(--primary)); }
        }

        input, textarea {
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 16px;
            border-radius: 16px;
            font-size: 1rem;
            width: 100%;
            max-width: 280px;
            outline: none;
            margin-bottom: 15px;
            font-family: inherit;
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 15px rgba(255, 46, 99, 0.3);
        }

        /* Updated Video Frame Container */
        #video-screen .video-container {
            width: 100%;
            max-width: 400px;
            aspect-ratio: 16/9;
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid var(--glass-border);
            box-shadow: 0 0 30px rgba(255, 46, 99, 0.2);
        }

        #video-screen iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .modal-card { width: 90%; max-width: 400px; padding: 30px; border: 1px solid var(--primary); }
        .modal-body { color: #ddd; line-height: 1.6; margin: 20px 0; max-height: 40vh; overflow-y: auto; white-space: pre-wrap; }

        .visualizer-container { position: relative; width: 260px; height: 220px; margin: 0 auto 30px; }
        .heart-svg { width: 100%; height: 100%; }
        .heart-segment { fill: var(--empty); transition: fill 0.8s ease; }
        .heart-segment.filled { fill: var(--primary); }

        .interaction-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 30px; }
        .task-trigger { padding: 16px; text-align: left; cursor: pointer; }
        .task-trigger.locked { opacity: 0.2; cursor: not-allowed; }
        .task-trigger.completed { border-color: rgba(255, 46, 99, 0.3); background: rgba(255, 46, 99, 0.05); }
        .task-trigger span { display: block; font-size: 0.65rem; color: var(--accent); font-weight: 700; text-transform: uppercase; }
        .task-trigger strong { display: block; font-size: 0.85rem; }

        .detail-view { padding: 24px; margin-top: 20px; }
        .clue-box { background: rgba(255, 46, 99, 0.1); border: 1px dashed var(--primary); padding: 16px; border-radius: 16px; margin-top: 20px; color: var(--accent); }

        #manager-panel { background: #111; padding: 20px; border-radius: 20px; text-align: left; margin-top: 40px; }
        .hidden { display: none !important; }
        .loading-ring { border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="app">
        <!-- 0. Loading State -->
        <div id="loading-screen" class="overlay-screen">
            <div class="heart-icon">❤️</div>
            <div class="loading-ring"></div>
            <p id="loading-text">Syncing Love...</p>
        </div>

        <!-- 1. Login Screen -->
        <div id="login-screen" class="overlay-screen hidden">
            <div class="heart-icon">❤️</div>
            <h1 style="font-size: 1.5rem">The Distance Vault</h1>
            <p style="color: #888; margin-bottom: 20px">When did it all begin?</p>
            <input type="number" id="passcode" placeholder="YYYY">
            <button id="login-btn">Unlock</button>
        </div>

        <!-- 2. Video Stage (Updated for Google Drive Embedding) -->
        <div id="video-screen" class="overlay-screen hidden">
            <h2 style="margin-bottom: 20px; font-size: 1.2rem;">A Message For You</h2>
            <div class="video-container">
                <iframe id="intro-video-frame" src="" allow="autoplay"></iframe>
            </div>
            <button onclick="skipVideo()" style="margin-top: 25px; background: transparent; border: 1px solid var(--glass-border);">Continue to Agenda</button>
        </div>

        <!-- 3. Welcome Modal -->
        <div id="welcome-modal" class="overlay-screen hidden">
            <div class="modal-card glass">
                <h2 style="color: var(--primary); margin: 0;">For You, My Love</h2>
                <div id="welcome-text-display" class="modal-body"></div>
                <button onclick="closeModal()">Start Our Day</button>
            </div>
        </div>

        <!-- 4. Main Dashboard -->
        <div id="main-content" class="hidden">
            <h1>Hi Beautiful ❤️</h1>
            <p style="color: #888; margin-bottom: 30px;">Every step brings us closer.</p>

            <div class="visualizer-container">
                <svg viewBox="0 0 32 29.6" class="heart-svg">
                    <defs>
                        <path id="heartPath" d="M23.6,0c-3.4,0-6.4,2.7-7.6,5.6C14.7,2.7,11.8,0,8.4,0C3.8,0,0,3.8,0,8.4c0,5.4,5,9.6,16,19.2 c11-9.6,16-13.8,16-19.2C32,3.8,28.2,0,23.6,0z"/>
                        <clipPath id="clipHeart"><use xlink:href="#heartPath"/></clipPath>
                    </defs>
                    <g id="heart-dynamic-segments" clip-path="url(#clipHeart)"></g>
                    <use xlink:href="#heartPath" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.3"/>
                </svg>
            </div>

            <div class="interaction-grid" id="interaction-grid"></div>

            <div id="task-detail" class="detail-view glass hidden">
                <div id="detail-content"></div>
            </div>

            <!-- Manager Section -->
            <div id="manager-panel" class="hidden">
                <h3 style="margin:0 0 10px 0">Settings</h3>
                <label>Correct Year:</label><br>
                <input type="number" id="edit-year" style="max-width:100%"><br>
                <label>Welcome Message:</label><br>
                <textarea id="edit-welcome" rows="5" style="max-width:100%"></textarea>
                <button id="save-config-btn" style="width:100%">Save Config</button>
                <hr style="border:0; border-top:1px solid #333; margin:20px 0">
                <p style="font-size:0.7rem; color: #888">Current User ID: <span id="user-uid"></span></p>
                <button onclick="resetAllProgress()" style="background:#444; width:100%; font-size:0.8rem">Reset Progress</button>
            </div>
            
            <p onclick="document.getElementById('manager-panel').classList.toggle('hidden')" style="opacity: 0.2; font-size: 0.7rem; margin-top: 40px; cursor: pointer;">Settings</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAf3nUe7taCcOLOzc2Rf4taBsMfI2-sFG0",
            authDomain: "valentines-16b75.firebaseapp.com",
            projectId: "valentines-16b75",
            storageBucket: "valentines-16b75.firebasestorage.app",
            messagingSenderId: "874081783784",
            appId: "1:874081783784:web:366560e5c9010996e9de5d",
            measurementId: "G-JKK5Q1GY4X"
        };

        let app, auth, db;
        const appId = 'valentines-remote-live';

        let config = { passcode: "2017", welcomeMessage: "Welcome message here..." };
        let agenda = [];
        let activeIndex = -1;
        let user = null;

        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, (u) => {
                    if (u) {
                        user = u;
                        document.getElementById('user-uid').innerText = u.uid;
                        startSync();
                    }
                });

                await signInAnonymously(auth);
            } catch (err) {
                console.error("Auth failed", err);
                const loadingText = document.getElementById('loading-text');
                if (err.code === 'auth/configuration-not-found') {
                    loadingText.innerHTML = "Firebase Auth Error: Ensure 'Anonymous' sign-in is enabled.";
                } else {
                    loadingText.innerHTML = "Connection Error: " + err.message;
                }
            }
        }

        function startSync() {
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'config', 'appState');
            
            onSnapshot(docRef, (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    config = data.config || config;
                    agenda = data.agenda || [
                        { time: "09:00 AM", title: "Morning Kisses", desc: "吹个亲亲在镜子里。", clue: "礼物在门口。", completed: false },
                        { time: "09:00 PM", title: "Midnight Date", desc: "开视频见面。", clue: "我有惊喜给你。", completed: false }
                    ];
                    renderApp();
                } else {
                    saveAllData();
                }
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
            }, (err) => {
                console.error("Firestore sync error:", err);
                document.getElementById('loading-text').innerText = "Database Error.";
            });
        }

        async function saveAllData() {
            if (!user) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'config', 'appState');
            await setDoc(docRef, { config, agenda });
        }

        window.checkPasscode = () => {
            const val = document.getElementById('passcode').value;
            if (val === config.passcode.toString()) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('video-screen').classList.remove('hidden');
                
                // Embed the Google Drive link using the /preview endpoint
                const videoFrame = document.getElementById('intro-video-frame');
                videoFrame.src = "https://drive.google.com/file/d/1NNv05Q7CYbwwxIuZOgx_qBoP10QqIRXF/preview";
            } else {
                alert("That's not the year, my love.");
            }
        };

        window.skipVideo = () => {
            document.getElementById('video-screen').classList.add('hidden');
            document.getElementById('welcome-modal').classList.remove('hidden');
            document.getElementById('welcome-text-display').innerText = config.welcomeMessage;
            
            // Clear iframe src to stop playback
            document.getElementById('intro-video-frame').src = "";
        };

        window.closeModal = () => {
            document.getElementById('welcome-modal').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
        };

        function renderApp() {
            const container = document.getElementById('heart-dynamic-segments');
            container.innerHTML = '';
            const widthPer = 32 / (agenda.length || 1);

            agenda.forEach((item, i) => {
                const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                rect.setAttribute("id", `seg-${i}`);
                rect.setAttribute("x", i * widthPer);
                rect.setAttribute("y", "0");
                rect.setAttribute("width", widthPer + 0.1);
                rect.setAttribute("height", "30");
                rect.setAttribute("class", `heart-segment ${item.completed ? 'filled' : ''}`);
                container.appendChild(rect);
            });

            const grid = document.getElementById('interaction-grid');
            grid.innerHTML = '';
            agenda.forEach((item, i) => {
                const isLocked = i > 0 && !agenda[i - 1].completed;
                const btn = document.createElement('div');
                btn.className = `task-trigger glass ${isLocked ? 'locked' : ''} ${item.completed ? 'completed' : ''} ${activeIndex === i ? 'active-now' : ''}`;
                btn.innerHTML = `<span>${item.time}</span><strong>${item.title}</strong>`;
                btn.onclick = () => { if (!isLocked) showTask(i); };
                grid.appendChild(btn);
            });

            if (activeIndex !== -1) showTask(activeIndex);
        }

        function showTask(index) {
            activeIndex = index;
            const item = agenda[index];
            const detail = document.getElementById('task-detail');
            detail.classList.remove('hidden');
            
            document.getElementById('detail-content').innerHTML = `
                <span style="color: var(--primary); font-weight: 700; text-transform: uppercase; font-size: 0.7rem;">${item.time}</span>
                <h2 style="margin: 10px 0;">${item.title}</h2>
                <p style="color: #bbb; line-height: 1.6; font-size: 0.95rem;">${item.desc}</p>
                ${!item.completed ? `<button id="complete-btn">I've Done This</button>` : 
                `<div class="clue-box"><strong>REWARD:</strong><br>${item.clue}</div>`}
            `;
            
            const cBtn = document.getElementById('complete-btn');
            if (cBtn) cBtn.onclick = window.completeCurrent;
        }

        window.completeCurrent = async () => {
            if (activeIndex === -1) return;
            agenda[activeIndex].completed = true;
            await saveAllData();
        };

        window.saveSettings = async () => {
            config.passcode = document.getElementById('edit-year').value;
            config.welcomeMessage = document.getElementById('edit-welcome').value;
            await saveAllData();
            alert("Settings saved in cloud!");
        };

        window.resetAllProgress = async () => {
            if(confirm("Reset progress for both of you?")) {
                agenda.forEach(a => a.completed = false);
                await saveAllData();
                activeIndex = -1;
                document.getElementById('task-detail').classList.add('hidden');
            }
        };

        document.getElementById('login-btn').onclick = window.checkPasscode;
        document.getElementById('save-config-btn').onclick = window.saveSettings;

        initFirebase();
    </script>
</body>
</html>
