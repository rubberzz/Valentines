<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Valentine's Agenda ‚ù§Ô∏è</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>

    <style>
        :root {
            --primary: #ff2e63;
            --bg: #0a0a0a;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.12);
            --text: #ffffff;
            --accent: #ff8ca6;
            --bg-gradient: radial-gradient(circle at 10% 10%, rgba(255, 46, 99, 0.12) 0%, transparent 40%),
                            radial-gradient(circle at 90% 90%, rgba(255, 46, 99, 0.12) 0%, transparent 40%);
        }

        body.naughty-mode {
            --primary: #b026ff;
            --accent: #e0aaff;
            --bg-gradient: radial-gradient(circle at 10% 10%, rgba(176, 38, 255, 0.15) 0%, transparent 40%),
                            radial-gradient(circle at 90% 90%, rgba(176, 38, 255, 0.15) 0%, transparent 40%);
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: var(--bg);
            background-image: var(--bg-gradient);
            color: var(--text);
            margin: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            overflow-x: hidden;
            transition: background 0.8s ease;
        }

        #app { width: 100%; max-width: 450px; padding: 20px 16px; text-align: center; z-index: 10; }

        .floating-container { position: fixed; inset: 0; pointer-events: none; z-index: 5; overflow: hidden; }
        .floater { position: absolute; bottom: -50px; opacity: 0.6; animation: float-up var(--duration) linear infinite; }
        
        @keyframes float-up {
            0% { transform: translateY(0) rotate(0deg); opacity: 0; }
            10% { opacity: 0.6; }
            100% { transform: translateY(-110vh) rotate(360deg); opacity: 0; }
        }

        .glass { 
            background: rgba(15, 15, 15, 0.85); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px); 
            border: 1px solid var(--glass-border); 
            border-radius: 24px; 
        }

        /* Heart Jar Styling */
        .jar-container {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            position: relative;
        }
        .heart-jar {
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.05);
            border: 2px solid var(--primary);
            position: relative;
            clip-path: path('M60 115C60 115 115 80 115 45C115 25 100 5 80 5C68 5 60 15 60 15C60 15 52 5 40 5C20 5 5 25 5 45C5 80 60 115 60 115Z');
            overflow: hidden;
            transition: 0.3s;
        }
        .jar-content {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            flex-wrap: wrap-reverse;
            justify-content: center;
            align-content: flex-start;
            padding: 5px;
            gap: 2px;
        }
        .jar-item { font-size: 14px; animation: drop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes drop-in { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .overlay-screen { 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,1); 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            z-index: 2000; 
            padding: 30px; 
            transition: opacity 1s ease, visibility 1s;
        }

        .heart-icon { font-size: 3.5rem; color: var(--primary); margin-bottom: 20px; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); filter: drop-shadow(0 0 10px var(--primary)); } 50% { transform: scale(1.1); filter: drop-shadow(0 0 25px var(--primary)); } }

        .mode-toggle { 
            display: flex; 
            background: rgba(255,255,255,0.05); 
            padding: 4px; 
            border-radius: 100px; 
            margin: 10px auto 15px; 
            width: fit-content; 
            border: 1px solid var(--glass-border); 
            position: relative; 
            z-index: 20; 
        }
        .toggle-btn { 
            padding: 10px 24px; 
            border-radius: 100px; 
            cursor: pointer; 
            font-size: 0.85rem; 
            font-weight: 600; 
            transition: 0.3s; 
        }
        .toggle-btn.active { background: var(--primary); color: white; }

        input, textarea, select { 
            background: rgba(255, 255, 255, 0.07); 
            border: 1px solid var(--glass-border); 
            color: white; 
            padding: 14px; 
            border-radius: 12px; 
            width: 100%; 
            box-sizing: border-box; 
            margin-bottom: 12px; 
            font-size: 16px; 
        }

        button { 
            background: var(--primary); 
            color: white; 
            border: none; 
            padding: 16px; 
            border-radius: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            width: 100%; 
            transition: 0.3s;
        }
        button:active { transform: scale(0.98); }
        .btn-small { padding: 8px 12px; border-radius: 8px; font-size: 0.8rem; width: auto; }
        .btn-danger { background: #ff4d4d; }

        .interaction-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
        .task-trigger { 
            padding: 20px; 
            text-align: left; 
            cursor: pointer; 
            border: 1px solid var(--glass-border); 
            border-radius: 20px; 
            transition: 0.3s;
            min-height: 110px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
        }
        .task-trigger.locked { opacity: 0.25; filter: grayscale(1); pointer-events: none; }
        .task-trigger.completed { border-color: var(--primary); background: rgba(255, 46, 99, 0.1); }
        .badge-tag { position: absolute; top: 10px; right: 10px; font-size: 0.6rem; background: var(--primary); padding: 3px 8px; border-radius: 20px; font-weight: bold; }
        .badge-tag.msg { background: rgba(255,255,255,0.15); border: 1px solid var(--glass-border); }

        /* Professional Video Modal */
        #video-modal {
            position: fixed;
            inset: 0;
            z-index: 4000;
            display: none;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .video-container {
            width: 100%;
            max-width: 800px;
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 40px var(--primary);
            border: 1px solid var(--glass-border);
        }
        .video-header {
            padding: 20px;
            background: rgba(255,255,255,0.03);
            border-bottom: 1px solid var(--glass-border);
            text-align: center;
        }
        .video-footer {
            padding: 25px;
            text-align: center;
        }

        #task-modal, #admin-modal, #game-modal { 
            position: fixed; 
            inset: 0; 
            z-index: 3000; 
            display: none; 
            align-items: center; 
            justify-content: center; 
            padding: 20px; 
            background: rgba(0,0,0,0.95); 
        }

        .video-wrapper { position: relative; width: 100%; padding-top: 56.25%; }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }

        .admin-list { max-height: 400px; overflow-y: auto; text-align: left; margin-top: 20px; padding-right: 5px; }
        .admin-item { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 16px; margin-bottom: 10px; border: 1px solid var(--glass-border); }
        
        #game-canvas { background: #000; border-radius: 12px; max-width: 100%; cursor: crosshair; }

        .hidden { display: none !important; }
        label { display: block; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 6px; color: var(--accent); opacity: 0.8; }
    </style>
</head>
<body class="romance-mode">

    <div id="floating-elements" class="floating-container"></div>

    <div id="app">
        <div id="loading-screen" class="overlay-screen">
            <div class="heart-icon">‚ù§Ô∏è</div>
            <p>Syncing our memories...</p>
        </div>

        <div id="login-screen" class="overlay-screen hidden">
            <div class="heart-icon">‚ù§Ô∏è</div>
            <h1>Identity Check</h1>
            <p style="color: #ccc; margin-bottom: 30px;">"Only my favorite person can enter here."</p>
            <input type="number" id="passcode" placeholder="What year did we meet?">
            <button id="login-btn">Verify Identity</button>
        </div>

        <!-- Professional Video Modal -->
        <div id="video-modal">
            <div class="video-container">
                <div class="video-header">
                    <h2 style="margin:0; font-size: 1.2rem; letter-spacing: 1px;">A MESSAGE FOR YOU</h2>
                    <p style="margin:5px 0 0; font-size: 0.75rem; opacity: 0.6;">Watch before beginning your Valentine's Day journey</p>
                </div>
                <div class="video-wrapper">
                    <iframe id="drive-video-frame" src="" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                </div>
                <div class="video-footer">
                    <button onclick="closeVideoModal()" style="width: auto; padding: 14px 50px; border-radius: 40px; text-transform: uppercase; letter-spacing: 1px;">
                        Enter My Agenda ‚ù§Ô∏è
                    </button>
                </div>
            </div>
        </div>

        <div id="main-content" class="hidden">
            <div class="glass" style="padding: 20px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <div style="text-align: left;">
                    <h1 style="margin:0; font-size: 1.2rem;">Valentine's Agenda</h1>
                    <p id="progress-text" style="margin:0; font-size: 0.7rem; opacity: 0.6;">0 tasks completed</p>
                </div>
                <span id="admin-trigger" onclick="openAdmin()" style="cursor: pointer; font-size: 1.5rem; transition: 0.3s;" class="heart-pulse">‚ù§Ô∏è</span>
            </div>

            <!-- Heart/Naughty Jar -->
            <div class="jar-container" title="Complete tasks to fill the jar!">
                <div class="heart-jar">
                    <div id="jar-fill" class="jar-content"></div>
                </div>
            </div>

            <div class="mode-toggle">
                <div id="toggle-romance" class="toggle-btn active" onclick="switchMode('romance')">Romance</div>
                <div id="toggle-naughty" class="toggle-btn" onclick="switchMode('naughty')">Naughty</div>
            </div>
            
            <div class="interaction-grid" id="interaction-grid"></div>
        </div>

        <div id="task-modal">
            <div class="glass" style="width: 100%; max-width: 380px; padding: 30px;">
                <div id="task-modal-content"></div>
                <button onclick="closeModal()" style="margin-top: 20px; background: rgba(255,255,255,0.1);">Close</button>
            </div>
        </div>

        <div id="admin-modal">
            <div class="glass" style="width: 100%; max-width: 400px; padding: 25px; overflow-y: auto; max-height: 90vh;">
                <h3 style="margin-top:0;">Agenda Master Panel</h3>
                <div style="text-align: left;">
                    <label>Task Category</label>
                    <select id="new-task-board">
                        <option value="romance">Romantic Task ‚ù§Ô∏è</option>
                        <option value="naughty">Naughty Task üòà</option>
                    </select>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label>Time</label>
                            <input type="text" id="new-task-time" placeholder="e.g. 09:00">
                        </div>
                        <div>
                            <label>Task Style</label>
                            <select id="new-task-is-game" onchange="toggleGameOptions()">
                                <option value="false">Message/Question</option>
                                <option value="true">Mini-Game</option>
                            </select>
                        </div>
                    </div>

                    <label>Title</label>
                    <input type="text" id="new-task-title" placeholder="Task Title">
                    
                    <label>Description</label>
                    <textarea id="new-task-desc" placeholder="Details about this task..."></textarea>
                    
                    <div id="standard-task-options">
                        <label>Completion Question</label>
                        <input type="text" id="new-task-question" placeholder="e.g. What was inside?">
                        <label>Answer to Unlock Clue</label>
                        <input type="text" id="new-task-answer" placeholder="Correct answer">
                    </div>

                    <div id="game-task-options" class="hidden">
                        <label>Mini Game Type</label>
                        <select id="new-task-type">
                            <option value="romantic-bouquet">Bouquet Catcher</option>
                            <option value="naughty-night">Midnight Peek</option>
                            <option value="memory">Memory Match</option>
                            <option value="love-catcher">Classic Love Catcher</option>
                        </select>
                    </div>

                    <label>Secret Clue (Reward)</label>
                    <input type="text" id="new-task-clue" placeholder="Unlocked when completed">
                    
                    <button onclick="saveNewTask()" style="margin-top:10px;">Create Task</button>
                </div>
                <div class="admin-list" id="admin-list"></div>
                <button onclick="closeAdmin()" style="margin-top: 20px; background: rgba(255,255,255,0.1);">Close Panel</button>
            </div>
        </div>

        <div id="game-modal">
            <div class="glass" style="width: 100%; max-width: 400px; padding: 20px;">
                <h2 id="game-title">Game Time!</h2>
                <div id="game-container" style="position: relative;">
                    <canvas id="game-canvas" width="350" height="400"></canvas>
                    <div id="game-ui" style="position: absolute; top: 10px; left: 10px; pointer-events: none;"></div>
                </div>
                <p id="game-instructions" style="font-size: 0.8rem; margin: 15px 0;"></p>
                <button id="game-complete-btn" class="hidden">Finish & Claim Reward</button>
                <button onclick="closeGame()" style="margin-top: 10px; background: rgba(255,255,255,0.05);">Quit Game</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAf3nUe7taCcOLOzc2Rf4taBsMfI2-sFG0",
            authDomain: "valentines-16b75.firebaseapp.com",
            projectId: "valentines-16b75",
            storageBucket: "valentines-16b75.firebasestorage.app",
            messagingSenderId: "874081783784",
            appId: "1:874081783784:web:366560e5c9010996e9de5d",
            measurementId: "G-JKK5Q1GY4X"
        };

        const appId = 'vday-prod-v1';
        const videoId = '1NNv05Q7CYbwwxIuZOgx_qBoP10QqIRXF';
        let auth, db, user;
        let boards = { romance: [], naughty: [] };
        let config = { passcode: "2017" };
        let currentMode = 'romance';

        async function init() {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            await signInAnonymously(auth);
            onAuthStateChanged(auth, (u) => { if(u) { user = u; syncData(); } });
        }

        function syncData() {
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'config', 'appState');
            onSnapshot(docRef, (snap) => {
                document.getElementById('loading-screen').classList.add('hidden');
                if (snap.exists()) {
                    const data = snap.data();
                    boards = data.boards || boards;
                    config = data.config || config;
                    if(sessionStorage.getItem('vday_auth')) unlockApp(false);
                    else document.getElementById('login-screen').classList.remove('hidden');
                } else {
                    seedInitialData();
                }
                renderTasks();
                updateJar();
            }, (err) => console.error("Sync error:", err));
        }

        async function seedInitialData() {
            const initialBoards = {
                romance: [{ time: "09:00", title: "Morning Surprise", desc: "Check under your pillow...", completed: false, question: "Did you find it?", answer: "yes", clue: "Clue #1", isGame: false, type: "standard" }],
                naughty: [{ time: "22:00", title: "Midnight Special", desc: "Meet me...", completed: false, question: "Are you ready?", answer: "yes", clue: "Naughty Clue", isGame: false, type: "standard" }]
            };
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'appState'), { config: { passcode: "2017" }, boards: initialBoards });
        }

        function unlockApp(triggerVideo = true) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            if(triggerVideo) openVideoModal();
            sessionStorage.setItem('vday_auth', 'true');
            initFloatingDecor();
        }

        window.toggleGameOptions = () => {
            const isGame = document.getElementById('new-task-is-game').value === 'true';
            document.getElementById('standard-task-options').classList.toggle('hidden', isGame);
            document.getElementById('game-task-options').classList.toggle('hidden', !isGame);
        };

        function updateJar() {
            const fill = document.getElementById('jar-fill');
            const progressText = document.getElementById('progress-text');
            const currentAgenda = boards[currentMode] || [];
            const completedCount = currentAgenda.filter(t => t.completed).length;
            const total = currentAgenda.length;
            
            progressText.innerText = `${completedCount} of ${total} tasks completed`;
            fill.innerHTML = '';
            
            const icon = currentMode === 'romance' ? '‚ù§Ô∏è' : 'üòà';
            for(let i = 0; i < completedCount; i++) {
                const item = document.createElement('span');
                item.className = 'jar-item';
                item.innerText = icon;
                fill.appendChild(item);
            }
        }

        window.openAdmin = () => {
            document.getElementById('admin-modal').style.display = 'flex';
            renderAdminList();
        };

        window.closeAdmin = () => { document.getElementById('admin-modal').style.display = 'none'; };

        function renderAdminList() {
            const list = document.getElementById('admin-list');
            list.innerHTML = `<h4 style="margin:20px 0 10px; color:var(--primary)">ROMANCE BOARD</h4>`;
            boards.romance.forEach((t, i) => list.appendChild(createAdminItem('romance', t, i)));
            list.innerHTML += `<h4 style="margin:30px 0 10px; color:var(--primary)">NAUGHTY BOARD</h4>`;
            boards.naughty.forEach((t, i) => list.appendChild(createAdminItem('naughty', t, i)));
        }

        function createAdminItem(boardKey, t, i) {
            const item = document.createElement('div');
            item.className = 'admin-item';
            item.innerHTML = `
                <div style="font-size:0.7rem; opacity:0.7; font-weight:bold;">${t.time} ‚Ä¢ ${t.isGame ? 'GAME' : 'MSG'}</div>
                <strong style="display:block; margin:4px 0;">${t.title}</strong>
                <div style="margin-top:10px; display:flex; gap:8px;">
                    <button class="btn-small" onclick="moveTask('${boardKey}', ${i}, -1)" style="flex:1">‚Üë</button>
                    <button class="btn-small" onclick="moveTask('${boardKey}', ${i}, 1)" style="flex:1">‚Üì</button>
                    <button class="btn-small btn-danger" onclick="deleteTask('${boardKey}', ${i})" style="flex:1">DEL</button>
                </div>
            `;
            return item;
        }

        window.moveTask = async (boardKey, idx, dir) => {
            const newIdx = idx + dir;
            if(newIdx < 0 || newIdx >= boards[boardKey].length) return;
            const temp = boards[boardKey][idx];
            boards[boardKey][idx] = boards[boardKey][newIdx];
            boards[boardKey][newIdx] = temp;
            await saveBoard();
            renderAdminList();
        };

        window.deleteTask = async (boardKey, idx) => {
            if(!confirm("Delete this task?")) return;
            boards[boardKey].splice(idx, 1);
            await saveBoard();
            renderAdminList();
        };

        window.saveNewTask = async () => {
            const targetBoard = document.getElementById('new-task-board').value;
            const time = document.getElementById('new-task-time').value;
            const isGame = document.getElementById('new-task-is-game').value === 'true';
            const title = document.getElementById('new-task-title').value;
            const desc = document.getElementById('new-task-desc').value;
            const question = document.getElementById('new-task-question').value;
            const answer = document.getElementById('new-task-answer').value;
            const clue = document.getElementById('new-task-clue').value;
            const type = isGame ? document.getElementById('new-task-type').value : 'standard';

            if(!time || !title) return alert("Time and Title required");

            boards[targetBoard].push({ 
                time, title, desc, question, answer, clue, type, 
                isGame, completed: false 
            });
            await saveBoard();
            
            ['new-task-time', 'new-task-title', 'new-task-desc', 'new-task-question', 'new-task-answer', 'new-task-clue'].forEach(id => document.getElementById(id).value = '');
            renderAdminList();
        };

        async function saveBoard() {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'appState'), { config, boards });
        }

        window.openVideoModal = () => {
            const frame = document.getElementById('drive-video-frame');
            frame.src = `https://drive.google.com/file/d/${videoId}/preview?autoplay=1`;
            document.getElementById('video-modal').style.display = 'flex';
        };

        window.closeVideoModal = () => {
            document.getElementById('drive-video-frame').src = "";
            document.getElementById('video-modal').style.display = 'none';
        };

        window.switchMode = (m) => {
            currentMode = m;
            document.body.className = m === 'naughty' ? 'naughty-mode' : 'romance-mode';
            document.getElementById('toggle-romance').classList.toggle('active', m === 'romance');
            document.getElementById('toggle-naughty').classList.toggle('active', m === 'naughty');
            initFloatingDecor(); renderTasks(); updateJar();
        };

        function renderTasks() {
            const grid = document.getElementById('interaction-grid');
            grid.innerHTML = '';
            const currentAgenda = boards[currentMode] || [];
            currentAgenda.forEach((t, i) => {
                const isLocked = i > 0 && !currentAgenda[i-1].completed;
                const div = document.createElement('div');
                div.className = `task-trigger glass ${isLocked ? 'locked' : ''} ${t.completed ? 'completed' : ''}`;
                div.innerHTML = `
                    <span class="badge-tag ${!t.isGame ? 'msg' : ''}">${t.isGame ? 'GAME' : 'QUEST'}</span>
                    <span style="color:var(--primary); font-size:0.7rem; font-weight:800;">${t.time}</span>
                    <strong>${t.title}</strong>
                `;
                div.onclick = () => { if(!isLocked) openModal(i); };
                grid.appendChild(div);
            });
        }

        window.openModal = (idx) => {
            const t = boards[currentMode][idx];
            const content = document.getElementById('task-modal-content');
            content.innerHTML = `
                <h2 style="color:var(--primary); margin-bottom:10px;">${t.title}</h2>
                <p style="line-height:1.6; font-size:0.95rem; opacity:0.9;">${t.desc}</p>
            `;
            
            if(!t.completed) {
                if(!t.isGame) {
                    content.innerHTML += `
                        <div style="margin-top:25px; text-align:left; border-top: 1px solid var(--glass-border); padding-top:20px;">
                            <label>${t.question || 'Task Question'}</label>
                            <input type="text" id="task-answer-input" placeholder="Type your answer...">
                            <button id="verify-btn">Submit Answer ‚ù§Ô∏è</button>
                        </div>
                    `;
                    setTimeout(() => {
                        document.getElementById('verify-btn').onclick = async () => {
                            const val = document.getElementById('task-answer-input').value.toLowerCase().trim();
                            if(val === (t.answer || 'done').toLowerCase()) {
                                boards[currentMode][idx].completed = true;
                                await saveBoard();
                                openModal(idx);
                            } else {
                                alert("Not quite, my love. Try again!");
                            }
                        };
                    }, 0);
                } else {
                    content.innerHTML += `
                        <div style="margin-top:25px; padding-top:20px; border-top: 1px solid var(--glass-border);">
                            <p style="font-size:0.8rem; opacity:0.6; margin-bottom:15px;">Complete the mini-game to unlock your secret clue.</p>
                            <button id="game-start-btn">Start Mini-Game üéÆ</button>
                        </div>
                    `;
                    setTimeout(() => {
                        document.getElementById('game-start-btn').onclick = () => {
                            closeModal();
                            startGame(t.type, idx);
                        };
                    }, 0);
                }
            } else {
                content.innerHTML += `
                    <div style="padding:20px; background:rgba(255,46,99,0.1); border:1px dashed var(--primary); border-radius:16px; margin-top:25px;">
                        <span style="font-size:0.7rem; font-weight:800; text-transform:uppercase; color:var(--primary);">Secret Clue Unlocked</span>
                        <div style="margin-top:8px; font-size:1.1rem; font-weight:600;">${t.clue}</div>
                    </div>
                `;
            }
            document.getElementById('task-modal').style.display = 'flex';
        };

        window.closeModal = () => { document.getElementById('task-modal').style.display = 'none'; };

        let gameLoop;
        window.startGame = (type, taskIdx) => {
            document.getElementById('game-modal').style.display = 'flex';
            document.getElementById('game-complete-btn').classList.add('hidden');
            const canvas = document.getElementById('game-canvas');
            const ctx = canvas.getContext('2d');
            const instructions = document.getElementById('game-instructions');
            
            if(gameLoop) cancelAnimationFrame(gameLoop);

            const completeGame = async () => {
                boards[currentMode][taskIdx].completed = true;
                await saveBoard();
                document.getElementById('game-complete-btn').classList.remove('hidden');
                document.getElementById('game-complete-btn').onclick = () => {
                    closeGame();
                    openModal(taskIdx);
                };
            };

            // Mini Games Logic
            if(type === 'love-catcher' || type === 'romantic-bouquet') {
                const icon = type === 'romantic-bouquet' ? 'üåπ' : '‚ù§Ô∏è';
                instructions.innerText = `Control with mouse/touch to catch 10 ${icon}'s!`;
                let caught = 0;
                let items = [];
                let playerX = 175;
                canvas.onmousemove = (e) => playerX = e.offsetX;
                canvas.ontouchmove = (e) => playerX = e.touches[0].clientX - canvas.getBoundingClientRect().left;

                function loop() {
                    ctx.clearRect(0,0,350,400);
                    ctx.fillStyle = varColor('--primary');
                    ctx.fillRect(playerX - 25, 370, 50, 10);
                    if(Math.random() < 0.05) items.push({x: Math.random()*330, y: 0});
                    items.forEach((h, i) => {
                        h.y += 3;
                        ctx.font = "24px Arial";
                        ctx.fillText(icon, h.x, h.y);
                        if(h.y > 360 && h.x > playerX - 30 && h.x < playerX + 30) { items.splice(i, 1); caught++; }
                    });
                    document.getElementById('game-ui').innerHTML = `<h3 style='color:var(--primary)'>Progress: ${caught}/10</h3>`;
                    if(caught >= 10) completeGame(); else gameLoop = requestAnimationFrame(loop);
                }
                loop();
            } else if(type === 'naughty-night') {
                instructions.innerText = "Be quick! Tap 15 floating emojis to win!";
                let popped = 0;
                let heart = {x: 175, y: 200, r: 25};
                canvas.onclick = (e) => {
                    if(Math.hypot(e.offsetX - heart.x, e.offsetY - heart.y) < heart.r) {
                        popped++;
                        heart = {x: 30 + Math.random()*290, y: 30 + Math.random()*340, r: 25};
                    }
                };
                function loop() {
                    ctx.clearRect(0,0,350,400);
                    ctx.font = "40px Arial";
                    ctx.fillText("üòà", heart.x-20, heart.y+15);
                    document.getElementById('game-ui').innerHTML = `<h3 style='color:var(--primary)'>Count: ${popped}/15</h3>`;
                    if(popped >= 15) completeGame(); else gameLoop = requestAnimationFrame(loop);
                }
                loop();
            } else if(type === 'memory') {
                instructions.innerText = "Match all the pairs to reveal the clue!";
                const sym = currentMode === 'naughty' ? ["üòà","üîû","üïØÔ∏è","üë†","üßä","üç∑"] : ["‚ù§Ô∏è","üíñ","‚ú®","üåπ","üíç","üç´"];
                let cards = [...sym, ...sym].sort(() => Math.random() - 0.5).map(s => ({s, rev: false, mat: false}));
                let sel = [];
                canvas.onclick = (e) => {
                    const idx = Math.floor(e.offsetY / 100) * 3 + Math.floor(e.offsetX / (350/3));
                    if(cards[idx] && !cards[idx].rev && sel.length < 2) {
                        cards[idx].rev = true; sel.push(idx);
                        if(sel.length === 2) {
                            if(cards[sel[0]].s === cards[sel[1]].s) { cards[sel[0]].mat = true; cards[sel[1]].mat = true; sel = []; }
                            else { setTimeout(() => { if(cards[sel[0]]) cards[sel[0]].rev = false; if(cards[sel[1]]) cards[sel[1]].rev = false; sel = []; }, 800); }
                        }
                    }
                };
                function loop() {
                    ctx.clearRect(0,0,350,400);
                    cards.forEach((c, i) => {
                        const x = (i % 3) * (350/3), y = Math.floor(i / 3) * 100;
                        ctx.strokeStyle = "rgba(255,255,255,0.2)"; ctx.strokeRect(x+5, y+5, (350/3)-10, 90);
                        if(c.rev || c.mat) { ctx.font = "40px Arial"; ctx.fillText(c.s, x+30, y+65); }
                    });
                    if(cards.every(c => c.mat)) completeGame(); else gameLoop = requestAnimationFrame(loop);
                }
                loop();
            }
        };

        function varColor(name) {
            return getComputedStyle(document.body).getPropertyValue(name).trim();
        }

        window.closeGame = () => {
            if(gameLoop) cancelAnimationFrame(gameLoop);
            document.getElementById('game-modal').style.display = 'none';
        };

        function initFloatingDecor() {
            const container = document.getElementById('floating-elements');
            container.innerHTML = '';
            const char = currentMode === 'romance' ? '‚ù§Ô∏è' : 'üòà';
            for(let i = 0; i < 20; i++) {
                const el = document.createElement('div');
                el.className = 'floater'; el.innerText = char;
                el.style.left = Math.random() * 100 + 'vw';
                el.style.fontSize = (Math.random() * 20 + 20) + 'px';
                el.style.setProperty('--duration', (Math.random() * 5 + 7) + 's');
                el.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(el);
            }
        }

        document.getElementById('login-btn').onclick = () => {
            if(document.getElementById('passcode').value === config.passcode) unlockApp(true);
            else alert("Try again, love!");
        };

        init();
    </script>
</body>
</html>
